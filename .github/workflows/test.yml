name: Tests

on:
    push:
        branches:
            - main
    workflow_dispatch:
    pull_request:
        branches:
            - main
    workflow_call:

# Set default permissions for all jobs
permissions:
    contents: read # Needed to check out code
    checks: write # Needed to report test results
    pull-requests: write # Needed to add comments/annotations to PRs

jobs:
    quality-checks:
        runs-on: ubuntu-latest
        name: Quality Checks
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Quality Checks (Parallel)
              run: bun run ci:check-all

    test:
        needs: quality-checks
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        name: ${{ matrix.os == 'ubuntu-latest' && 'test' || format('test ({0})', matrix.os) }}
        defaults:
            run:
                shell: bash
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Build the extension and tests (without redundant checks)
            - name: Build Tests and Extension
              id: build_step
              run: bun run ci:build

            - name: Unit Tests with coverage - Linux
              id: unit_tests_linux
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' && runner.os == 'Linux' }}
              run: |
                  bunx nyc --nycrc-path .nycrc.unit.json --reporter=lcov bun run test:unit

            - name: Unit Tests - Non-Linux
              id: unit_tests_non_linux
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' && runner.os != 'Linux' }}
              run: |
                  bun run test:unit

            - name: Extension Integration Tests - Linux
              id: integration_tests_linux
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' && runner.os == 'Linux' }}
              run: xvfb-run -a bun run test:coverage

            - name: Extension Integration Tests - Non-Linux
              id: integration_tests_non_linux
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' && runner.os != 'Linux' }}
              run: bun run test:integration

            - name: Webview Tests with Coverage
              id: webview_tests
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' }}
              run: |
                  cd webview-ui
                  bun run test:coverage

            - name: CLI Tests
              id: cli_tests
              if: ${{ !cancelled() && steps.build_step.outcome == 'success' }}
              run: cd cli && bun run test:run

            - name: Save Coverage Reports
              uses: actions/upload-artifact@v4
              # Only upload artifacts on Linux - We only need coverage from one OS
              if: runner.os == 'Linux'
              with:
                  name: pr-coverage-reports
                  path: |
                      coverage-unit/lcov.info
                      webview-ui/coverage/lcov.info

    test-platform-integration:
        needs: quality-checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Download ripgrep binaries
              run: bun run download-ripgrep

            - name: Compile Standalone
              run: bun run compile-standalone

            - name: Install testing platform dependencies
              run: cd testing-platform && bun install

            - name: Running testing platform integration spec tests
              timeout-minutes: 7
              run: bun run test:tp-orchestrator -- tests/specs/ --count=1 --coverage

            - name: Save Coverage Reports
              uses: actions/upload-artifact@v4
              with:
                name: test-platform-integration-core-coverage
                path: coverage/**/lcov.info

    qlty:
        needs: [test, test-platform-integration]
        runs-on: ubuntu-latest
        # Run on PRs to main, pushes to main, and manual dispatches
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download unit tests coverage reports
              uses: actions/download-artifact@v4
              with:
                  name: pr-coverage-reports
                  path: .

            - name: Upload core unit tests coverage to Qlty
              uses: qltysh/qlty-action/coverage@v2
              with:
                  token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
                  # we can merge multiple files if necessary
                  files: |
                    coverage-unit/lcov.info
                  tag: unit:core

            - name: Upload webview-ui unit tests coverage to Qlty
              uses: qltysh/qlty-action/coverage@v2
              with:
                  token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
                  # we can merge multiple files if necessary
                  files: |
                    webview-ui/coverage/lcov.info
                  tag: unit:webview-ui
                  add-prefix: webview-ui/

            - name: Download test platform integration core coverage artifact
              uses: actions/download-artifact@v4
              continue-on-error: true
              id: download-integration-coverage
              with:
                name: test-platform-integration-core-coverage
                path: integration-core-coverage-reports

            - name: Upload core integration tests coverage to Qlty
              if: steps.download-integration-coverage.outcome == 'success'
              uses: qltysh/qlty-action/coverage@v2
              with:
                token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
                files: integration-core-coverage-reports/**/lcov.info
                tag: integration:core
